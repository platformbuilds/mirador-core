name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop, v9.0.0, 'release/**' ]
    # Removed paths-ignore to ensure documentation changes trigger builds
  pull_request:
    branches: [ '**' ]
    # Removed paths-ignore to ensure documentation changes are validated
  schedule:
    - cron: '0 3 * * 1'  # Weekly security scan on Mondays
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  packages: write

jobs:
  # Main CI job - build, test, coverage
  ci:
    name: Build, Test & Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Download modules
        run: go mod download

      - name: Lint (golangci-lint)
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=5m

      - name: Lint (go vet)
        run: go vet ./...

      - name: Test with coverage
        run: |
          set -o pipefail
          go test ./... -race -covermode=atomic -coverprofile=coverage.out 2>&1 | tee test.out

      - name: Generate JUnit report
        run: |
          go install github.com/jstemmer/go-junit-report/v2@latest
          cat test.out | "$HOME"/go/bin/go-junit-report > junit.xml || true

      - name: Coverage summary
        run: |
          if [ -f coverage.out ]; then
            go tool cover -func=coverage.out | tee coverage.txt
            total=$(go tool cover -func=coverage.out | awk '/total:/ {print $3}')
            echo "COVERAGE=$total" >> $GITHUB_ENV
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v5
        with:
          name: test-artifacts
          path: |
            coverage.out
            coverage.txt
            junit.xml
            test.out
          if-no-files-found: ignore

  # Security scanning job
  security:
    name: Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          $HOME/go/bin/govulncheck ./... | tee govulncheck.txt

      - name: Upload govulncheck report
        uses: actions/upload-artifact@v5
        with:
          name: govulncheck-report
          path: govulncheck.txt

  # CodeQL security analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: go

      - name: Download dependencies
        run: go mod download

      - name: Build Go code
        run: go build ./...

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  # Documentation validation and ReadTheDocs trigger
  docs:
    name: Documentation & ReadTheDocs
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && contains(fromJSON('["main", "master", "v9.0.0"]'), github.ref_name)) ||
      (github.event_name == 'pull_request' && contains(fromJSON('["main", "master", "v9.0.0"]'), github.base_ref)) ||
      contains(github.event.head_commit.message, '[docs]') ||
      contains(github.event.pull_request.title, '[docs]')
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install documentation dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r docs/requirements.txt

      - name: Validate documentation build
        run: |
          cd docs
          python -m sphinx -b html . _build/html

      - name: Check for broken links (optional)
        run: |
          cd docs
          python -m sphinx -b linkcheck . _build/linkcheck || true
        continue-on-error: true

      - name: Trigger ReadTheDocs Build
        run: |
          # Check if ReadTheDocs webhook URL is configured
          if [ -n "${RTD_WEBHOOK_URL}" ]; then
            echo "Triggering ReadTheDocs build via webhook..."
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{\"branches\": [\"${GITHUB_REF_NAME}\"], \"token\": \"${RTD_TOKEN}\"}" \
              "${RTD_WEBHOOK_URL}"
          else
            echo "ReadTheDocs webhook URL not configured. Please set RTD_WEBHOOK_URL and RTD_TOKEN secrets."
            echo "You can also configure ReadTheDocs to build automatically on pushes to the repository."
            echo "For manual setup instructions, visit: https://docs.readthedocs.io/en/stable/webhooks.html"
          fi
        env:
          RTD_WEBHOOK_URL: ${{ secrets.RTD_WEBHOOK_URL }}
          RTD_TOKEN: ${{ secrets.RTD_TOKEN }}

      - name: Upload docs artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: docs-build-artifacts
          path: docs/_build/
          retention-days: 7

  # Docker image build and push job
  deploy:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: [ci, security]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Log in to DockerHub
        run: |
          echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login docker.io -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/mirador-core
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker images
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ github.sha }}
            BUILD_TIME=${{ steps.meta.outputs.build-date }}
            COMMIT_HASH=${{ github.sha }}

  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [ci]
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install dependencies
        run: go mod download

      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

      - name: Ensure Docker Compose
        run: |
          set -euxo pipefail
          # Try installing via apt first (works when Docker apt repo is present)
          sudo apt-get update || true
          if apt-cache policy docker-compose-plugin | grep -q Candidate; then
            sudo apt-get -y install docker-compose-plugin docker-compose || true
          else
            echo "docker-compose-plugin not available from apt; installing Compose CLI plugin from GitHub releases"
            ARCH_UNAME="$(uname -m)"
            case "$ARCH_UNAME" in
              x86_64) ARCH=amd64 ;;
              aarch64|arm64) ARCH=arm64 ;;
              *) ARCH="$ARCH_UNAME" ;;
            esac
            TAG=$(curl -sL https://api.github.com/repos/docker/compose/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
            mkdir -p /usr/local/lib/docker/cli-plugins
            curl -fsSL "https://github.com/docker/compose/releases/download/${TAG}/docker-compose-linux-${ARCH}" -o /usr/local/lib/docker/cli-plugins/docker-compose
            chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
            ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose
            docker compose version || true
          fi

      - name: Run E2E pipeline
        run: |
          make e2e

    # End of deploy job


    