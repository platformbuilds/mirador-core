name: Deploy API Documentation

on:
  push:
    branches: [ main, master ]
    paths:
      - 'api/openapi.yaml'
      - 'docs/api-reference.md'
      - '.github/workflows/deploy-api-docs.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'api/openapi.yaml'
      - 'docs/api-reference.md'
      - '.github/workflows/deploy-api-docs.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        npm install -g redoc-cli
        pip install pyyaml jinja2

    - name: Generate HTML API docs
      run: |
        mkdir -p api-docs
        redoc-cli bundle api/openapi.yaml -o api-docs/index.html --title "MIRADOR-CORE API Reference"

    - name: Generate Markdown API docs
      run: |
        python3 -c "
        import yaml
        import json
        from pathlib import Path

        # Load OpenAPI spec
        with open('api/openapi.yaml', 'r') as f:
            spec = yaml.safe_load(f)

        # Generate endpoint summary
        endpoints = []
        for path, methods in spec.get('paths', {}).items():
            for method, details in methods.items():
                endpoints.append({
                    'method': method.upper(),
                    'path': path,
                    'summary': details.get('summary', ''),
                    'description': details.get('description', '')
                })

        # Write to markdown
        with open('api-docs/endpoints.md', 'w') as f:
            f.write('# API Endpoints\\n\\n')
            for endpoint in sorted(endpoints, key=lambda x: x['path']):
                f.write(f\"## {endpoint['method']} {endpoint['path']}\\n\")
                if endpoint['summary']:
                    f.write(f\"**{endpoint['summary']}**\\n\\n\")
                if endpoint['description']:
                    f.write(f\"{endpoint['description']}\\n\\n\")
                f.write('---\\n\\n')
        "

    - name: Copy API reference
      run: cp docs/api-reference.md api-docs/

    - name: Create index page
      run: |
        cat > api-docs/README.md << 'EOF'
        # MIRADOR-CORE API Documentation

        Welcome to the MIRADOR-CORE API documentation.

        ## Quick Links

        - [Interactive API Reference](index.html) - Browse the API interactively
        - [API Endpoints](endpoints.md) - List of all available endpoints
        - [API Reference Guide](api-reference.md) - Detailed API reference

        ## Overview

        MIRADOR-CORE provides a unified observability platform that integrates metrics, logs, traces, and AI-powered analysis capabilities.

        ## Getting Started

        1. Review the [API Reference Guide](api-reference.md) for authentication and usage patterns
        2. Explore the [Interactive API Reference](index.html) to test endpoints
        3. Check the [Endpoints List](endpoints.md) for available operations

        ## Support

        For questions or issues, please refer to the main [MIRADOR-CORE documentation](https://mirador-core.readthedocs.io/).
        EOF

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './api-docs'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4