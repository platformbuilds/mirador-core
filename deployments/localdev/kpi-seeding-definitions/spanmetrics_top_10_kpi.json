{
  "span_metrics_technical_kpis": [
    {
      "kpi_name": "Span Duration 95th Percentile",
      "kpi_formula": "histogram_quantile(0.95, sum(rate(traces_span_metrics_duration_milliseconds_bucket[5m])) by (le, service_name, span_name))",
      "kpi_definition": "The duration for the slowest 5% of spans by service and operation. High values indicate performance bottlenecks in specific services or operations.",
      "layer": "cause",
      "classifier": "span_performance",
      "sentiment": "negative",
      "signal_type": "metrics",
      "query_type": "PromQL",
      "datastore": "victoriametrics"
    },
    {
      "kpi_name": "Span Error Rate",
      "kpi_formula": "sum(rate(traces_span_metrics_calls_total{status_code=\"ERROR\"}[5m])) by (service_name, span_name) / sum(rate(traces_span_metrics_calls_total[5m])) by (service_name, span_name) * 100",
      "kpi_definition": "The percentage of spans that end in error status by service and operation. High error rates indicate reliability issues in specific service operations.",
      "layer": "cause",
      "classifier": "span_reliability",
      "sentiment": "negative",
      "signal_type": "metrics",
      "query_type": "PromQL",
      "datastore": "victoriametrics"
    },
    {
      "kpi_name": "Weighted Anomaly Score by Operation",
      "kpi_formula": "avg by (service_name, span_name) (iforest_anomaly_score * rate(traces_span_metrics_calls_total[5m]))",
      "kpi_definition": "The average anomaly score weighted by operation volume. Higher scores indicate operations with more significant and frequent anomalous behavior patterns requiring investigation.",
      "layer": "cause",
      "classifier": "operation_anomaly",
      "sentiment": "negative",
      "signal_type": "metrics",
      "query_type": "PromQL",
      "datastore": "victoriametrics"
    },
    {
      "kpi_name": "Average Span Duration",
      "kpi_formula": "sum(rate(traces_span_metrics_duration_milliseconds_sum[5m])) by (service_name, span_name) / sum(rate(traces_span_metrics_duration_milliseconds_count[5m])) by (service_name, span_name)",
      "kpi_definition": "The average duration of spans by service and operation. Provides a baseline for performance expectations and detects gradual degradation.",
      "layer": "cause",
      "classifier": "average_performance",
      "sentiment": "negative",
      "signal_type": "metrics",
      "query_type": "PromQL",
      "datastore": "victoriametrics"
    },
    {
      "kpi_name": "Client vs Server Span Performance",
      "kpi_formula": "histogram_quantile(0.95, sum(rate(traces_span_metrics_duration_milliseconds_bucket{span_kind=~\"SPAN_KIND_CLIENT|SPAN_KIND_SERVER\"}[5m])) by (le, span_kind))",
      "kpi_definition": "The 95th percentile latency comparison between client and server spans. Helps identify if issues are in outgoing calls or request processing.",
      "layer": "cause",
      "classifier": "span_kind_analysis",
      "sentiment": "negative",
      "signal_type": "metrics",
      "query_type": "PromQL",
      "datastore": "victoriametrics"
    },
    {
      "kpi_name": "High Anomaly Score Span Rate",
      "kpi_formula": "sum(rate(traces_span_metrics_calls_total[5m])) by (service_name, span_name) * iforest_anomaly_score > 0.9",
      "kpi_definition": "The rate of span executions with anomaly scores above 0.9. Identifies operations experiencing the most severe anomalous behavior requiring immediate attention.",
      "layer": "cause",
      "classifier": "critical_anomaly",
      "sentiment": "negative",
      "signal_type": "metrics",
      "query_type": "PromQL",
      "datastore": "victoriametrics"
    },
    {
      "kpi_name": "Critical Operation Success Rate",
      "kpi_formula": "sum(rate(traces_span_metrics_calls_total{span_name=~\"process_transaction|authorize_payment\", status_code=\"OK\"}[5m])) by (span_name) / sum(rate(traces_span_metrics_calls_total{span_name=~\"process_transaction|authorize_payment\"}[5m])) by (span_name) * 100",
      "kpi_definition": "The success rate for critical business operations. Monitors the reliability of key transaction processing functions.",
      "layer": "cause",
      "classifier": "business_operation_health",
      "sentiment": "positive",
      "signal_type": "metrics",
      "query_type": "PromQL",
      "datastore": "victoriametrics"
    },
    {
      "kpi_name": "High Latency Operation Ratio",
      "kpi_formula": "sum(rate(traces_span_metrics_duration_milliseconds_count{le=\"2000\"}[5m])) by (service_name, span_name) / sum(rate(traces_span_metrics_duration_milliseconds_count[5m])) by (service_name, span_name) * 100",
      "kpi_definition": "The percentage of operations taking longer than 2 seconds. Identifies operations with severe performance issues requiring optimization.",
      "layer": "cause",
      "classifier": "performance_degradation",
      "sentiment": "negative",
      "signal_type": "metrics",
      "query_type": "PromQL",
      "datastore": "victoriametrics"
    },
    {
      "kpi_name": "Anomaly Score Trend by Service",
      "kpi_formula": "delta(avg(iforest_anomaly_score * rate(traces_span_metrics_calls_total[5m])) by (service_name)[1h:])",
      "kpi_definition": "The change in average anomaly score per service over the last hour. Positive trends indicate deteriorating stability, while negative trends indicate improving service health.",
      "layer": "cause",
      "classifier": "service_anomaly_trend",
      "sentiment": "negative",
      "signal_type": "metrics",
      "query_type": "PromQL",
      "datastore": "victoriametrics"
    },
    {
      "kpi_name": "Error Budget Burn Rate",
      "kpi_formula": "sum(rate(traces_span_metrics_calls_total{status_code=\"ERROR\"}[5m])) by (service_name) / (sum(rate(traces_span_metrics_calls_total[5m])) by (service_name) * 0.01)",
      "kpi_definition": "How quickly services are consuming their error budget (assuming 1% error budget). Values > 1 indicate services are burning through error budget faster than allocated.",
      "layer": "cause",
      "classifier": "slo_compliance",
      "sentiment": "negative",
      "signal_type": "metrics",
      "query_type": "PromQL",
      "datastore": "victoriametrics"
    }
  ]
}