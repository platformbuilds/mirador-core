project: mirador-core
component: kpis-api
owner: platformbuilds/backend
timezone: Asia/Kolkata

# Incorporates your updates:
# - KPI definitions live in Weaviate (vector DB) and are cached in Valkey (in-memory)
# - KPIs can target Metrics, Log fields (VictoriaLogs), and Traces (VictoriaTraces)
# - Core exposes schema APIs for metrics, logsfields, traces/services
# - Signals carry sentiment (POSITIVE/NEGATIVE) and a layer (IMPACT/CAUSE)

goals:
  - Implement sovereign KPI Definitions API backed by Weaviate (+ Valkey hot cache)
  - Support KPIs over metrics, logsfields, and traces with safe formulas
  - Expose/consume schema APIs to annotate signals with sentiment & layer
  - Provide batched value reads via VictoriaMetrics/Logs/Traces
  - Enforce multi-tenant RBAC, auditing, and rate limits

constraints:
  - Air-gapped; no external SaaS calls
  - Open-source stack: Go, Weaviate, Valkey, VictoriaMetrics/Logs/Traces, OTel
  - Transport: HTTP/JSON (no gRPC to mirador-rca)

tech_stack:
  language: go>=1.22
  http: gin (or chi) with OTel middleware
  vector_db: weaviate (on-prem)
  cache: valkey
  time_series: victoria-metrics
  logs: victoria-logs
  traces: victoria-traces
  config: viper (env+file)
  validation: go-playground/validator + jsonschema (generated)

env:
  dev:
    weaviate_url: http://localhost:8081
    valkey_addr: localhost:6379
    victoria_metrics: http://localhost:8428
    victoria_logs: http://localhost:9428
    victoria_traces: http://localhost:8429
  prod:
    weaviate_url: http://weaviate:8080
    valkey_addr: valkey:6379
    victoria_metrics: http://victoriametrics:8428
    victoria_logs: http://victorialogs:9428
    victoria_traces: http://victoriatraces:8429

config:
  env_vars:
    HTTP_ADDR: ":8080"
    TENANCY_HEADER: "X-Tenant-Id"
    AUTH_JWKS_URL: "http://auth/.well-known/jwks.json"
    RATE_RPS_PER_USER: "5"
    RATE_RPS_PER_TENANT: "50"
    KPI_MAX_FORMULA_NODES: "64"
    KPI_BATCH_MAX: "200"
    CACHE_TTL_SEC: "60"

domain_model:
  # Stored in Weaviate; cached materialized in Valkey for fast reads
  kpi_def:
    id: uuid
    tenant_id: string
    owner_user_id: string
    name: string
    kind: "business" | "tech"
    unit: string|null
    format: "number"|"pct"|"currency"|"duration"|null
    visibility: "private"|"team"|"org"
    tags: string[]
    # query can reference metrics, logsfields, traces OR be a formula combining them
    query:
      oneof:
        - metric:
            ref: string            # timeseries name/selector
            aggregator: "avg"|"sum"|"p95"|"p99"
            filters?: map[string]string
        - logfield:
            ref: string            # e.g., log.field:status_code
            op: "count"|"rate"|"sum"|"avg"
            matcher?: string       # query expression for VictoriaLogs
        - trace:
            ref: string            # e.g., span.attr:http.status_code or service.latency
            op: "p95"|"p99"|"count"|"rate"
            matcher?: string
        - formula:
            expr: string           # safe grammar (+ - * / ( ) . _ identifiers)
            inputs: map[string, query]
    thresholds?:               # for status mapping
      - when: ">"|">="|"<"|"<="|"between"|"outside"
        value: number | [number, number]
        status: "ok"|"warn"|"crit"
    sentiment: "POSITIVE"|"NEGATIVE"   # increase means good/bad
    layer: "IMPACT"|"CAUSE"            # semantic classification
    layout?: { w:int, h:int, x?:int, y?:int }
    created_at: time
    updated_at: time
    deleted: bool

schema_catalog:  # served by mirador-core; may hydrate from Victoria* and cache in Valkey
  metric:
    - name: string
      labels: map[string]string
      sentiment: "POSITIVE"|"NEGATIVE"
      layer: "IMPACT"|"CAUSE"
  logsfield:
    - name: string
      type: "string"|"number"|"bool"
      examples?: string[]
      sentiment: "POSITIVE"|"NEGATIVE"
      layer: "IMPACT"|"CAUSE"
  service:
    - name: string
      namespace?: string
      sentiment: "POSITIVE"|"NEGATIVE"
      layer: "IMPACT"|"CAUSE"

api_contracts:
  base: /api/v1/kpi
  defs:
    - GET /defs
      query: { visibility?, ownerUserId?, q?, page?, pageSize? }
      resp: { defs: kpi_def[], nextPage?: string }
    - POST /defs
      body: kpi_def (id optional â†’ server assigns)
      resp: kpi_def
    - GET /defs/{id}
      resp: kpi_def
    - PUT /defs/{id}
      body: kpi_def
      resp: kpi_def
    - DELETE /defs/{id}
      resp: { ok: true }
  values_batch:
    - POST /values:batch
      body:
        tenantContext:
          timeRange: { from: string, to: string }
          stepSec?: int
        items: [{ id: string } | { id: string, overrideQuery?: query }]
        includeSpark: bool
      resp:
        results: [{ id: string, value?: number, spark?: [[ts,value]], error?: string }]
  schema:       # schema discovery APIs (also power UI builders)
    - GET /schema/metrics         -> { items: metric[] }
    - GET /schema/logsfields      -> { items: logsfield[] }
    - GET /schema/services        -> { items: service[] }
    - POST /schema/annotate       -> body: { name,type, sentiment, layer } -> { ok: true }

rbac:
  permissions:
    - kpi.read
    - kpi.write
    - schema.read
    - schema.write   # annotate sentiment/layer
  visibility_rules:
    private: owner_user_id == caller
    team: caller.team_id matches def.team_id (if modeled later)
    org: tenant-scoped; requires org role
  quotas:
    - max_defs_per_user: 200
  rate_limits:
    - per-user: ${RATE_RPS_PER_USER}
    - per-tenant: ${RATE_RPS_PER_TENANT}

persistence_design:
  weaviate:
    class: KPI_Def
    vectorization: disabled (manual embeddings optional later)
    properties:
      - tenant_id, owner_user_id, name, kind, unit, format, visibility, tags (strings)
      - query_json, thresholds_json, sentiment, layer, layout_json
      - created_at, updated_at, deleted
    retrieval:
      - filter: where tenant_id == $tenant and deleted == false
      - search: BM25 on name,tags; optional vector search later
  valkey_cache:
    keys:
      - kpi:def:{tenant}:{id} -> json (TTL=${CACHE_TTL_SEC})
      - schema:metrics:{tenant} -> json (TTL=300)
      - schema:logsfields:{tenant} -> json (TTL=300)
      - schema:services:{tenant} -> json (TTL=300)
    ops:
      - write-through on create/update/delete
      - cache-bust on mutation

values_engine:
  fanout:
    - metric query -> VictoriaMetrics /api/v1/query_range or /query
    - logsfield -> VictoriaLogs query endpoint with matcher
    - trace -> VictoriaTraces aggregation API (latency p95/p99, span counts)
  formula_eval:
    - build AST (no reflection, no functions)
    - max nodes: ${KPI_MAX_FORMULA_NODES}
    - inputs resolved recursively; detect cycles
  optimizations:
    - batch identical metric/log/trace refs across items
    - worker pool (size = min(8, 2*CPU))
    - short-term cache in Valkey for hot refs (TTL=${CACHE_TTL_SEC})
  slos:
    - <= 300ms for 20 items (no spark)
    - <= 1.5s with spark(30 points)

observability:
  metrics:
    - http_requests_total{route,code,tenant}
    - kpi_values_batch_duration_seconds_bucket
    - kpi_cache_hit_total{kind=def|schema|value}
    - kpi_fanout_requests_total{target=vm|vlogs|vtraces,code}
    - rate_limited_total{scope=user|tenant}
  logs:
    - structured JSON; redact PII
    - audit logs for defs create/update/delete
  tracing:
    - span: kpi.values.batch
    - child spans per downstream call

security:
  - JWT verify (RS256 JWKS); extract tenant/roles
  - mTLS to Weaviate / Victoria* (cluster internal)
  - Body size limit: 64KB
  - Input validation & allowlist regex for refs
  - 429 with Retry-After when limited

error_model:
  - 400 validation_error
  - 401 unauthorized / 403 forbidden
  - 404 not_found
  - 409 conflict (duplicate name in tenant)
  - 429 rate_limited
  - 5xx internal_error with trace_id

plan:
  milestones:
    - M1_spec_schema_catalog (1d)
    - M2_weaviate_classes_and_repo (1.5d)
    - M3_defs_crud_handlers_rbac (2d)
    - M4_schema_endpoints + annotations (1.5d)
    - M5_values_engine_metrics_logs_traces (3d)
    - M6_cache_valkey_write_through (0.5d)
    - M7_observability_rate_limit_audit (1d)
    - M8_tests_perf_docs (2d)
    - total_estimate_days: 12.5
  tasks:
    - T1: Weaviate class & repository
      files:
        - internal/kpi/repo_weav.go
        - internal/kpi/model.go
      acceptance:
        - CRUD works across tenants; BM25 search on name/tags
    - T2: Valkey cache layer
      files:
        - internal/kpi/cache_valkey.go
      acceptance:
        - write-through & cache-bust; TTL honored
    - T3: Schema catalog endpoints
      files:
        - internal/schema/metrics.go
        - internal/schema/logsfields.go
        - internal/schema/services.go
        - internal/schema/http.go
      acceptance:
        - GET endpoints hydrate from Victoria*, cache in Valkey
        - POST /schema/annotate updates sentiment/layer and persists (Weaviate)
    - T4: KPI defs CRUD + RBAC
      files:
        - internal/kpi/http/handlers.go
        - cmd/mirador-core/main.go
      acceptance:
        - visibility rules enforced; audit logs written
    - T5: Values engine (metrics/logs/traces)
      files:
        - internal/kpi/values/metrics.go
        - internal/kpi/values/logs.go
        - internal/kpi/values/traces.go
        - internal/kpi/values/formula.go
      acceptance:
        - batch resolves mixed item types; cycles rejected; errors per-item
    - T6: Rate limiting & tracing
      files:
        - internal/platform/rate.go
        - internal/platform/tracing.go
      acceptance:
        - 429 with Retry-After; OTel spans across fanout
    - T7: Tests & perf
      files:
        - internal/kpi/*_test.go
        - test/perf/kpi_batch_bench_test.go
      acceptance:
        - SLOs met; >90% branches covered in evaluator
    - T8: Docs & OpenAPI
      files:
        - docs/api/kpi_defs.md
        - docs/api/kpi_values_batch.md
        - openapi/kpi.yaml

ci_cd:
  steps:
    - lint: golangci-lint run
    - unit: go test ./...
    - build: go build ./cmd/mirador-core
    - container: ghcr.io/platformbuilds/mirador-core:latest (non-root)
    - sbom: syft/grype (optional)

handoff_to_ui:
  - Provide OpenAPI for:
      - GET/POST/PUT/DELETE /api/v1/kpi/defs
      - POST /api/v1/kpi/values:batch
      - GET /api/v1/schema/{metrics,logsfields,services}
  - Sample payloads for metric/logfield/trace queries
  - Document sentiment & layer usage in UI badges/tooltips