# AGENTS.md

## Testing Procedures for Mirador Core

This document outlines the testing procedures for Mirador Core, following the established Makefile methods. These procedures ensure consistent, automated testing across different environments and scenarios.

## Overview

Mirador Core uses a comprehensive testing strategy that includes:
- Unit tests with race detection and coverage analysis
- End-to-end (E2E) testing with full environment setup
- Code quality checks (linting, formatting, vulnerability scanning)
- API endpoint testing
- Local development environment testing

## Testing Procedures

### 1. Unit Testing

Run unit tests with race detection and coverage analysis:

```bash
make test
```

This command:
- Generates protocol buffer code if needed
- Runs `go test -v -race -coverprofile=coverage.out ./...`
- Includes race detection for concurrent code issues
- Generates coverage reports

### 2. Code Quality Checks

#### Linting
```bash
make lint
```

Runs golangci-lint on the entire repository to check for code quality issues.

#### Code Formatting
```bash
make fmt
```

Formats code using `go fmt` and `goimports` for consistent styling.

#### Vulnerability Scanning
```bash
make vuln
```

Runs `govulncheck` to scan for known security vulnerabilities in dependencies.

### 3. End-to-End Testing

#### Full Local Development E2E
```bash
make localdev
```

This comprehensive test includes:
1. Starting the local development stack (`make localdev-up`)
2. Waiting for services to be ready (`make localdev-wait`)
3. Seeding synthetic OpenTelemetry data (`make localdev-seed-otel`)
4. Seeding default dashboard and KPIs (`make localdev-seed-data`)
5. Running E2E tests (`make localdev-test`)
6. Tearing down the stack (`make localdev-down`)

#### Individual E2E Components

**Start Local Development Stack:**
```bash
make localdev-up
```

**Wait for Services:**
```bash
make localdev-wait
```

**Seed OpenTelemetry Data:**
```bash
make localdev-seed-otel
```

**Seed Sample Data:**
```bash
make localdev-seed-data
```

**Run E2E Tests:**
```bash
make localdev-test
```

**Tear Down Stack:**
```bash
make localdev-down
```

### 4. API Testing Variants

#### Comprehensive E2E Pipeline
```bash
make localdev-test-all-api
```

Runs both code quality checks and API tests against a running server.

#### API Tests Only
```bash
make localdev-test-api-only
```

Runs API endpoint tests only, skipping code quality checks.

#### Code Quality Tests Only
```bash
make localdev-test-code-only
```

Runs code quality tests only (unit tests, formatting, linting, vulnerability checks).

### 5. Development Environment

#### Start Development Server
```bash
make dev
```

Starts the Mirador Core server in development mode using `go run`.

#### Setup Development Environment
```bash
make setup
```

Installs tools, generates protocol buffer code, and downloads dependencies.

## Environment Variables

- `BASE_URL`: Base URL for the running app (default: `http://localhost:8010`)
  - Used by `localdev-wait` and passed to tests as `E2E_BASE_URL`

## Test Reports and Outputs

- **Coverage Reports**: `coverage.out` (generated by `make test`)
- **E2E Reports**: `deployments/localdev/e2e-report.json` (generated by `make localdev-test`)
- **Test Results**: `localtesting/e2e-test-results.json` (generated by `make localdev-test-all-api`)
- **Failure Summary**: `localtesting/test-failures-table.md` (generated by `make localdev-test-all-api`)

## Prerequisites

Before running tests, ensure:

1. **Dependencies**: Run `make setup` to install required tools and dependencies
2. **Protocol Buffers**: Generated automatically by test targets if needed
3. **Docker**: Required for E2E testing with local development stack
4. **Go Tools**: Ensure `golangci-lint`, `govulncheck`, etc. are installed

## CI/CD Integration

These Makefile targets are designed to work in CI/CD pipelines:

- Use `make test` for unit test validation
- Use `make lint` and `make fmt` for code quality gates
- Use `make vuln` for security scanning
- Use `make localdev` for comprehensive E2E validation

## Troubleshooting

### Common Issues

1. **Protocol Buffer Generation**: If proto files are out of date, run `make proto-clean` to regenerate
2. **Missing Tools**: Run `make tools` to install development tools
3. **Port Conflicts**: Ensure ports 8010, 8080, 4317, etc. are available for local testing
4. **Docker Issues**: Ensure Docker is running and has sufficient resources for E2E tests

### Debug Commands

- Check tool availability: `make check-tools`
- Clean and rebuild: `make clean-build`
- View version info: `make version`

## Contributing

When adding new tests or modifying testing procedures:

1. Update this document to reflect changes
2. Ensure new tests follow the established Makefile patterns
3. Add appropriate targets to the Makefile if needed
4. Test in both local and CI environments</content>
<parameter name="filePath">/Users/aarvee/repos/github/public/miradorstack/mirador-core/AGENTS.md